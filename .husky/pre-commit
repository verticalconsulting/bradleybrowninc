#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "Running pre-commit checks..."

# Get list of staged CSS/SCSS files
STAGED_CSS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(scss|css)$' || true)

# Only check for missing image references if CSS/SCSS files are being committed
if [ -z "$STAGED_CSS_FILES" ]; then
  echo "✅ No CSS/SCSS files staged - skipping image reference check"
else
  echo "Checking for missing image references in CSS/SCSS files..."

  MISSING_FILES=0

  for file in $STAGED_CSS_FILES; do
  if [ -f "$file" ]; then
    # Check if the file contains any url() references
    if grep -q 'url(' "$file" 2>/dev/null; then
      # Extract url() references
      grep 'url(' "$file" | while IFS= read -r line; do
        # Extract the path from url() - simplified regex for better compatibility
        urls=$(echo "$line" | grep -o 'url([^)]*)')

        for url_match in $urls; do
          # Extract just the path, removing url() wrapper and quotes
          clean_url=$(echo "$url_match" | sed 's/url(//g' | sed 's/)//g' | sed 's/["\x27]//g' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')

          # Only check relative paths that start with ../ or ./
          if echo "$clean_url" | grep -qE '^\.\./|^\./'; then
            # Get the directory of the current file
            file_dir=$(dirname "$file")

            # Resolve the full path
            full_path="$file_dir/$clean_url"

            # Check if file exists
            if [ ! -f "$full_path" ]; then
              echo "❌ Missing file: $full_path (referenced in $file)"
              MISSING_FILES=$((MISSING_FILES + 1))
            fi
          fi
        done
      done
    fi
  fi
done

  if [ $MISSING_FILES -gt 0 ]; then
    echo "❌ Found $MISSING_FILES missing image reference(s)"
    echo "Please fix the missing image references before committing."
    exit 1
  fi

  echo "✅ All image references are valid"
fi

# Run prettier if available
if command -v npx &> /dev/null; then
  echo "Running Prettier..."
  STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(js|jsx|ts|tsx|json|css|scss|md)$' || true)
  if [ -n "$STAGED_FILES" ]; then
    echo "$STAGED_FILES" | xargs npx prettier --write 2>/dev/null || true
    echo "$STAGED_FILES" | xargs git add 2>/dev/null || true
  fi
fi

echo "✅ Pre-commit checks passed"
